<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ゆっくりココナッツ 公式サイト</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <ul>
                <li><a href="index.html" class="active">ホーム</a></li>
                <li><a href="announcements.html" id="nav-announcements">お知らせ</a></li>
                <li><a href="blog.html" id="nav-blog">ブログ</a></li>
            </ul>
            <button class="theme-toggle" id="theme-toggle" title="テーマを切り替え">
                <span id="theme-icon">☀️</span>
            </button>
        </div>
    </nav>
    <main class="container fade-in">
        <h1 class="text-outline" id="post-title">ゆっくりココナッツ 公式サイトへようこそ</h1>

        <!-- 1. 最新のコンテンツ（ブログ・お知らせ） -->
        <div id="content-section"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div>
                <h2 class="text-outline" style="font-size: 1.5rem;">最新のブログ記事</h2>
                <div id="latest-post-container">
                    <!-- JavaScriptでここに最新記事が入ります -->
                </div>
            </div>
            <div>
                <h2 class="text-outline" style="font-size: 1.5rem;">最新のお知らせ</h2>
                <div id="latest-announcement-container">
                    <!-- JavaScriptでここに最新のお知らせが入ります -->
                </div>
            </div>
        </div>

        <!-- 2. チャンネル登録ボタン（移動：記事の下） -->
        <div id="subscribe-section" style="text-align: center; margin: 2rem 0;">
            <a href="https://www.youtube.com/channel/UC9LpqPFPOh650jI6mO9Z2Xg" target="_blank" class="subscribe-btn">
                <span>▶</span> チャンネル登録はこちらから！
            </a>
        </div>

        <!-- 3. 自己紹介カード -->
        <div class="post-card">
            <p>ゆっくりココナッツのサイトです！頑張ってAIといっしょに作りました。</p>
            <p>このサイトではダークモードとライトモードを切り替えられるようになりました。</p>
            <p>今後から色々な機能を追加していく予定です。</p>
        </div>

        <!-- 4. YouTube最新動画（単独カード） -->
        <div id="youtube-section" class="post-card" style="margin-top: 2rem;">
            <h2 style="text-align: center; margin-bottom: 1rem;">YouTube 最新動画</h2>
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/kKWYwJGSnpM" allowfullscreen></iframe>
            </div>
        </div>
    </main>

    <!-- サイトガイドのテンプレート -->
    <div id="guide-overlay" class="guide-overlay"></div>
    <div id="guide-content" class="guide-content">
        <span class="guide-character">💡</span>
        <div id="guide-bubble" class="speech-bubble">
            ここはテストメッセージです
        </div>
        <div class="guide-btns">
            <button id="guide-skip" class="guide-btn guide-btn-secondary">スキップ</button>
            <button id="guide-next" class="guide-btn guide-btn-primary">次へ</button>
        </div>
    </div>

    <script src="blog-posts.js"></script>
    <script src="announcements.js"></script>
    <script>
        // Latest Content Logic
        function loadLatestContent() {
            // Load Blog
            const blogContainer = document.getElementById('latest-post-container');
            if (window.blogPosts && window.blogPosts.length > 0) {
                const post = window.blogPosts[0];
                blogContainer.innerHTML = `
                    <div class="post-card" style="height: 100%;">
                        <p class="post-date">${post.date}</p>
                        <h3 style="margin: 0.5rem 0;">${post.title}</h3>
                        <a href="${post.url}" class="subscribe-btn" style="display: inline-block; margin-top: 10px; text-decoration: none; font-size: 0.9rem; padding: 5px 15px;">記事を読む</a>
                    </div>
                `;
            } else {
                blogContainer.innerHTML = '<p>まだ記事がありません。</p>';
            }

            // Load Announcement
            const newsContainer = document.getElementById('latest-announcement-container');
            if (window.announcements && window.announcements.length > 0) {
                const news = window.announcements[0];
                newsContainer.innerHTML = `
                    <div class="post-card" style="height: 100%;">
                        <p class="post-date">${news.date}</p>
                        <h3 style="margin: 0.5rem 0;">${news.title}</h3>
                        <a href="${news.url}" class="subscribe-btn" style="display: inline-block; margin-top: 10px; text-decoration: none; font-size: 0.9rem; padding: 5px 15px;">詳細を見る</a>
                    </div>
                `;
            } else {
                newsContainer.innerHTML = '<p>まだお知らせはありません。</p>';
            }
        }


        loadLatestContent();

        // Site Guide Logic
        const guideSteps = [
            { text: "ようこそ！ゆっくりココナッツ公式サイトへ！使いかたを簡単に説明するね！", target: null },
            { text: "この「お知らせ」メニューからは、最新の情報をまとめて確認できるよ！", target: "nav-announcements" },
            { text: "こっちの「ブログ」メニューには、日々の出来事や企画を書いていくよ！", target: "nav-blog" },
            { text: "ここには新着の「ブログ」や「お知らせ」が表示されるよ。チェックしてみてね！", target: "content-section" },
            { text: "YouTubeのチャンネル登録はこのボタンからできるよ！", target: "subscribe-section" },
            { text: "最新の動画もここで直接見れちゃうんだ！", target: "youtube-section" },
            { text: "夜に見る時は、ここから「ダークモード」に切り替えると目に優しいよ！（今はデフォルトでダークになってるよ！）", target: "theme-toggle" },
            { text: "説明は以上だよ！ゆっくりしていってね！", target: null }
        ];

        let currentStep = 0;

        function startGuide() {
            // 既に見たことがあるかチェック
            if (localStorage.getItem('guideShown')) return;

            const overlay = document.getElementById('guide-overlay');
            const content = document.getElementById('guide-content');
            overlay.classList.add('active');
            content.classList.add('active');
            showStep(0);
        }

        function showStep(index) {
            const content = document.getElementById('guide-content');
            const bubble = document.getElementById('guide-bubble');
            const nextBtn = document.getElementById('guide-next');
            const step = guideSteps[index];

            // 前のハイライトを消す
            document.querySelectorAll('.guide-highlight').forEach(el => el.classList.remove('guide-highlight'));

            bubble.textContent = step.text;

            if (step.target) {
                const targetEl = document.getElementById(step.target);
                if (targetEl) {
                    targetEl.classList.add('guide-highlight');
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // 少しスクロールを待ってから位置計算
                    setTimeout(() => repositionGuide(targetEl, content), 400);
                }
            } else {
                // ターゲットがない場合は画面中央
                content.style.position = 'fixed';
                content.style.top = '50%';
                content.style.left = '50%';
                content.style.transform = 'translate(-50%, -50%)';
                content.classList.remove('guide-arrow-up', 'guide-arrow-down');
            }

            nextBtn.textContent = index === guideSteps.length - 1 ? '閉じる' : '次へ';
        }

        function repositionGuide(targetEl, content) {
            const rect = targetEl.getBoundingClientRect();
            const contentRect = content.getBoundingClientRect();
            const padding = 30; // ターゲットとの距離

            content.style.position = 'absolute';

            // 垂直位置：ターゲットの「上端」に合わせる (分かりやすくするため)
            let top = rect.top + window.scrollY;
            let arrowClass = '';

            // 水平位置：ターゲットの「右側」に配置
            let left = rect.right + window.scrollX + padding;

            // 画面の右側に入り切らない場合は「左側」に配置
            if (left + contentRect.width > window.innerWidth - 20) {
                left = rect.left + window.scrollX - contentRect.width - padding;

                // 左右どちらにも入り切らない場合は、上下に避ける
                if (left < 10) {
                    left = rect.left + window.scrollX + (rect.width / 2) - (contentRect.width / 2);
                    top = rect.top + window.scrollY - contentRect.height - padding;
                    arrowClass = 'guide-arrow-down';

                    if (rect.top < contentRect.height + padding + 50) {
                        top = rect.bottom + window.scrollY + padding;
                        arrowClass = 'guide-arrow-up';
                    }
                }
            }

            // 最終的な画面内への収まり調整
            const headerHeight = 80;
            if (top < window.scrollY + headerHeight) top = window.scrollY + headerHeight;

            // 画面左端からもはみ出さないようにガード
            if (left < 10) left = 10;
            // 画面右端からもはみ出さないようにガード
            if (left + contentRect.width > window.innerWidth - 10) {
                left = window.innerWidth - contentRect.width - 10;
            }

            content.style.top = `${top}px`;
            content.style.left = `${left}px`;
            content.style.transform = 'none';
            content.classList.remove('guide-arrow-up', 'guide-arrow-down');
            if (arrowClass) content.classList.add(arrowClass);
        }

        document.getElementById('guide-next').addEventListener('click', () => {
            currentStep++;
            if (currentStep < guideSteps.length) {
                showStep(currentStep);
            } else {
                closeGuide();
            }
        });

        document.getElementById('guide-skip').addEventListener('click', closeGuide);

        function closeGuide() {
            const overlay = document.getElementById('guide-overlay');
            const content = document.getElementById('guide-content');
            overlay.classList.remove('active');
            content.classList.remove('active');
            document.querySelectorAll('.guide-highlight').forEach(el => el.classList.remove('guide-highlight'));
            localStorage.setItem('guideShown', 'true');
        }

        // ページ読み込みから少し遅れて開始
        setTimeout(startGuide, 1000);

        // Theme logic
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const root = document.documentElement;
        // デフォルトをダークモードに変更
        const savedTheme = localStorage.getItem('theme') || 'dark';
        root.setAttribute('data-theme', savedTheme);
        themeIcon.textContent = savedTheme === 'dark' ? '🌙' : '☀️';

        themeToggle.addEventListener('click', () => {
            const currentTheme = root.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            root.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeIcon.textContent = newTheme === 'dark' ? '🌙' : '☀️';
        });
    </script>
</body>

</html>